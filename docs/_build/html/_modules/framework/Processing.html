<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>framework.Processing &mdash; CYSK Documentation 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            CYSK Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../framework.html">framework package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CYSK Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">framework.Processing</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for framework.Processing</h1><div class="highlight"><pre>
<span></span><span class="c1"># Math, image processing and other useful libraries</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MaxNLocator</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>

<span class="c1"># Image processing</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">regionprops</span>
<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="n">meijering</span><span class="p">,</span> <span class="n">sato</span><span class="p">,</span> <span class="n">frangi</span><span class="p">,</span> <span class="n">hessian</span><span class="p">,</span> <span class="n">threshold_otsu</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">extrema</span><span class="p">,</span> <span class="n">skeletonize</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">probabilistic_hough_line</span>
<span class="kn">from</span> <span class="nn">skimage.draw</span> <span class="kn">import</span> <span class="n">disk</span><span class="p">,</span> <span class="n">circle_perimeter</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span><span class="p">,</span> <span class="n">grey_closing</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">distance_matrix</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">restoration</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">roipoly</span> <span class="kn">import</span> <span class="n">RoiPoly</span>
<span class="kn">from</span> <span class="nn">matplotlib_scalebar.scalebar</span> <span class="kn">import</span> <span class="n">ScaleBar</span>
<span class="kn">from</span> <span class="nn">biosppy.signals</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">biosppy.stats</span> <span class="kn">import</span> <span class="n">pearson_correlation</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>

<span class="c1"># Plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">pltc</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># Widgets</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">interact_manual</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>

<span class="c1"># Feature Extraction (.py files by Teresa Parreira)</span>
<span class="c1"># from CytoSkeletonPropsMorph import CytoSkeletonPropsMorph</span>
<span class="c1"># from CytoSkeletonRegionPropsInt import RegionPropsInt</span>
<span class="c1"># from FreqAnalysis import FreqAnalysis</span>
<span class="c1"># from GLCM import GLCM</span>

<span class="c1"># Graph</span>
<span class="kn">import</span> <span class="nn">sknw</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">argrelextrema</span>

<span class="c1"># </span>
<span class="kn">from</span> <span class="nn">skan</span> <span class="kn">import</span> <span class="n">Skeleton</span><span class="p">,</span> <span class="n">summarize</span><span class="p">,</span><span class="n">draw</span>
<span class="kn">from</span> <span class="nn">skan.csr</span> <span class="kn">import</span> <span class="n">skeleton_to_csgraph</span><span class="p">,</span> <span class="n">sholl_analysis</span><span class="p">,</span><span class="n">make_degree_image</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Circle</span>
<span class="kn">from</span> <span class="nn">framework.ImageFeatures</span> <span class="kn">import</span> <span class="n">ImageFeatures</span><span class="p">,</span><span class="n">getvoxelsize</span>
<span class="kn">from</span> <span class="nn">framework.Functions</span> <span class="kn">import</span> <span class="n">cv2toski</span><span class="p">,</span><span class="n">pylsdtoski</span><span class="p">,</span><span class="n">polar_to_cartesian</span><span class="p">,</span> <span class="n">remove_not1D</span><span class="p">,</span> <span class="n">quantitative_analysis</span><span class="p">,</span><span class="n">hist_bin</span><span class="p">,</span><span class="n">hist_lim</span><span class="p">,</span><span class="n">create_separate_DFs</span><span class="p">,</span><span class="n">branch</span><span class="p">,</span><span class="n">graphAnalysis</span>
<span class="kn">from</span> <span class="nn">framework.Importing</span> <span class="kn">import</span> <span class="n">label_image</span><span class="p">,</span><span class="n">init_import</span>
<span class="c1">#from framework.PreProcessingCYTO import cytoskeleton_preprocessing, df_cytoskeleton_preprocessing</span>
<span class="c1">#from framework.PreProcessingNUCL import excludeborder, nuclei_preprocessing, df_nuclei_preprocessing, nuclei_segmentation</span>

<span class="c1">#from framework.visualization import truncate_colormap, plot_hist, plot_pie</span>
<span class="c1">#from fractal_dimension import fractal_dimension</span>
<span class="c1">#from fractal_analysis_fxns import boxcount,boxcount_grayscale,fractal_dimension,fractal_dimension_grayscale,fractal_dimension_grayscale_DBC</span>




<div class="viewcode-block" id="ROI_centroid"><a class="viewcode-back" href="../../framework.html#framework.Processing.ROI_centroid">[docs]</a><span class="k">def</span> <span class="nf">ROI_centroid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">img_id</span><span class="p">,</span><span class="n">ROIcoords</span><span class="p">):</span>
    <span class="n">centroid_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="s1">&#39;NUCL_PRE&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data_</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NUCL_PRE&#39;</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;NUCL_PRE&#39;</span><span class="p">][</span><span class="s1">&#39;Img Index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">img_id</span><span class="p">]</span>
        <span class="n">axa</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">axb</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="s1">&#39;3D&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">data_</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;3D&#39;</span><span class="p">][</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;3D&#39;</span><span class="p">][</span><span class="s1">&#39;Img Index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">img_id</span><span class="p">]</span>
        <span class="n">axa</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">axb</span> <span class="o">=</span> <span class="mi">2</span>
    
    <span class="c1"># GET: centroid inside ROI indexes</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">data_</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Centroid&#39;</span><span class="p">][</span><span class="n">axa</span><span class="p">]),</span><span class="nb">round</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Centroid&#39;</span><span class="p">][</span><span class="n">axb</span><span class="p">]))</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ROIcoords</span><span class="p">[</span><span class="n">axa</span><span class="p">],</span><span class="n">ROIcoords</span><span class="p">[</span><span class="n">axb</span><span class="p">])):</span>
            <span class="n">centroid_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">centroid_list</span> <span class="o">==</span> <span class="p">[]:</span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: No centroids within ROI&quot;</span><span class="p">);</span> <span class="k">return</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">centroid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: More than 1 centroid identified within ROI&quot;</span><span class="p">);</span>
    
    <span class="c1"># PLOT: first centroid identified and nucleus contour</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">data_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">centroid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Centroid&#39;</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">centroid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">centroid</span></div>

<div class="viewcode-block" id="line_segment_features"><a class="viewcode-back" href="../../framework.html#framework.Processing.line_segment_features">[docs]</a><span class="k">def</span> <span class="nf">line_segment_features</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="n">original_img</span><span class="p">,</span><span class="n">img_index</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">patch</span><span class="p">,</span><span class="n">xy</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">plot</span><span class="p">):</span>
    <span class="c1"># original_img = original skeleton image</span>
    <span class="c1"># img_index    = image index</span>
    <span class="c1"># mask         = ROI mask of desired cell </span>
    <span class="c1"># patch        = np.array with skeleton p atch</span>
    <span class="c1"># xy           = [x_,y_] = [(x1,x2),(y1,y2)]</span>
    <span class="c1"># centroids    = Centroids[image index] dataframe</span>
    
    <span class="c1"># Create flags</span>
    <span class="n">flagAlpha</span><span class="p">,</span> <span class="n">flagDtC</span><span class="p">,</span> <span class="n">flagTri</span><span class="p">,</span> <span class="n">flagLL</span><span class="p">,</span> <span class="n">flagTheta</span><span class="p">,</span> <span class="n">flagAG</span><span class="p">,</span> <span class="n">flagStdAD</span><span class="p">,</span> <span class="n">flagLLD</span><span class="p">,</span> <span class="n">flagStdLLD</span><span class="p">,</span> <span class="n">flagPAD</span><span class="p">,</span> <span class="n">flagMCM</span><span class="p">,</span> <span class="n">flagTAD</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span>
    
    <span class="c1"># Features</span>
    <span class="n">LSFs</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Get offset</span>
    <span class="n">x_</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_</span> <span class="o">=</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Get patch</span>
    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aux__</span>   <span class="o">=</span> <span class="n">original_img</span> <span class="o">*</span> <span class="n">mask</span>
        <span class="n">x_</span><span class="p">,</span><span class="n">y_</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">patch</span>   <span class="o">=</span> <span class="n">aux__</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">x_</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">x_</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">y_</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">y_</span><span class="p">)]</span>
        
    <span class="c1"># cytoskeleton centroid</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">aux__</span> <span class="o">*</span> <span class="mi">1</span>
    <span class="n">cytocenter</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">((</span><span class="n">aa</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span><span class="n">aa</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span>
     
    
    <span class="c1"># HOUGH ANALYSIS</span>
    <span class="n">lsd</span>   <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createLineSegmentDetector</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">LSD_REFINE_ADV</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">0.001</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">2048</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">cv2toski</span><span class="p">(</span><span class="n">lsd</span><span class="o">.</span><span class="n">detect</span><span class="p">((</span><span class="n">patch</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[((</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">),</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">)),(</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">),</span><span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="o">+</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">)))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span> <span class="c1"># Recenter (Fix offset)</span>
    
    <span class="c1"># Number of Lines</span>
    <span class="k">if</span> <span class="s1">&#39;LSF1D:Number of Lines&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF1D:Number of Lines&#39;</span><span class="p">,</span><span class="n">N</span><span class="p">)]</span>
    
    <span class="c1"># Distance matrix features</span>
    <span class="n">median_points</span> <span class="o">=</span> <span class="p">[((</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">d</span>             <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">(</span><span class="n">median_points</span><span class="p">,</span><span class="n">median_points</span><span class="p">);</span> <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>
    <span class="n">d_0</span>           <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">(</span><span class="n">median_points</span><span class="p">,</span><span class="n">median_points</span><span class="p">);</span> <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">d_0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    
    <span class="c1"># Intracluster metrics</span>
    <span class="k">if</span> <span class="s1">&#39;LSF1D:Complete Diameter Distance&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">max_d</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">LSFs</span>    <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF1D:Complete Diameter Distance&#39;</span><span class="p">,</span><span class="n">max_d</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="s1">&#39;LSF1D:Average Diameter Distance&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">avg_diam_dist</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d_0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">LSFs</span>    <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF1D:Average Diameter Distance&#39;</span><span class="p">,</span><span class="n">avg_diam_dist</span><span class="p">)]</span>
    
    
    <span class="n">center</span>         <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">median_points</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">median_points</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cent_diam_dist</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">median_points</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    
    <span class="c1"># Raise flags</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF2D:Alpha&#39;</span><span class="p">:</span>
            <span class="n">flagAlpha</span>   <span class="o">=</span> <span class="kc">True</span>
            <span class="n">angles</span>      <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF2D:Distances to Centroid&#39;</span><span class="p">:</span>
            <span class="n">flagDtC</span>     <span class="o">=</span> <span class="kc">True</span>
            <span class="n">dist_med</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF2D:Triangle Areas&#39;</span><span class="p">:</span>
            <span class="n">flagTri</span>     <span class="o">=</span> <span class="kc">True</span>
            <span class="n">triangleA</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF2D:Line Lengths&#39;</span><span class="p">:</span>
            <span class="n">flagLL</span>      <span class="o">=</span> <span class="kc">True</span>
            <span class="n">line_size</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF2D:Theta&#39;</span><span class="p">:</span>
            <span class="n">flagTheta</span>   <span class="o">=</span> <span class="kc">True</span>
            <span class="n">thetas</span>      <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF2D:Angle Difference&#39;</span><span class="p">:</span>
            <span class="n">flagAG</span>      <span class="o">=</span> <span class="kc">True</span>
            <span class="n">close_angle</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF2D:Std. Angle Difference&#39;</span><span class="p">:</span>
            <span class="n">flagStdAD</span>   <span class="o">=</span> <span class="kc">True</span>
            <span class="n">std_locals</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF2D:Local Line Distance&#39;</span><span class="p">:</span>
            <span class="n">flagLLD</span>     <span class="o">=</span> <span class="kc">True</span>
            <span class="n">prox</span>        <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF2D:Std. Local Line Distance&#39;</span><span class="p">:</span>
            <span class="n">flagStdLLD</span>  <span class="o">=</span> <span class="kc">True</span>
            <span class="n">std_dists</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF2D:PAD&#39;</span><span class="p">:</span>
            <span class="n">flagPAD</span>     <span class="o">=</span> <span class="kc">True</span>
            <span class="n">PADs</span>        <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF1D:MCM&#39;</span><span class="p">:</span>
            <span class="n">flagMCM</span>     <span class="o">=</span> <span class="kc">True</span>
            <span class="n">thetas_w</span>    <span class="o">=</span> <span class="p">[]</span>
            <span class="n">prev_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">prev_vs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;LSF1D:TAD&#39;</span><span class="p">:</span>
            <span class="n">flagTAD</span>     <span class="o">=</span> <span class="kc">True</span>
            
    

                                
    
    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">line</span>

        <span class="c1"># Prepare vectors - MANDATORY</span>
        <span class="n">med_point</span>      <span class="o">=</span> <span class="p">((</span><span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">center_med_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">med_point</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">line_vec</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
        <span class="n">center_p0</span>      <span class="o">=</span> <span class="n">p0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">center_p1</span>      <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        
        <span class="c1">### Features</span>
        <span class="c1"># ALPHA</span>
        <span class="k">if</span> <span class="n">flagAlpha</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">center_med_vec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">center_med_vec</span><span class="p">),</span> <span class="n">line_vec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">line_vec</span><span class="p">)))</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">if</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span> <span class="n">angle</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">-</span> <span class="n">angle</span><span class="p">;</span>
            
        <span class="k">if</span> <span class="n">flagTheta</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># THETA</span>
            <span class="k">if</span> <span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1">#theta = np.arctan(abs(p1[1]-p0[1])/abs(p1[0]-p0[0]))*180/np.pi</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">line_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">line_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="mi">90</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">:</span>  <span class="n">theta</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">+</span> <span class="n">theta</span><span class="p">;</span>
        
        <span class="k">if</span> <span class="n">flagMCM</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># MAIN VECTOR</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">prev_v</span> <span class="o">+</span> <span class="n">line_vec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">prev_v</span><span class="p">):</span>
                <span class="n">prev_v</span> <span class="o">=</span> <span class="n">prev_v</span> <span class="o">+</span> <span class="n">line_vec</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">prev_v</span> <span class="o">-</span> <span class="n">line_vec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">prev_v</span><span class="p">):</span>
                <span class="n">prev_v</span> <span class="o">=</span> <span class="n">prev_v</span> <span class="o">-</span> <span class="n">line_vec</span>
            <span class="n">prev_vs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">prev_v</span><span class="p">]</span>
            <span class="n">theta_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">line_vec</span><span class="p">)</span> <span class="o">*</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span> 
            <span class="n">thetas_w</span> <span class="o">+=</span> <span class="p">[</span><span class="n">theta_w</span><span class="p">]</span>
        
        <span class="c1">### LOCAL FEATURES</span>
        <span class="c1"># CLOSEST LINES vs. THIS LINE</span>
        <span class="n">copy_d</span>            <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="n">dists_to_medpoint</span> <span class="o">=</span> <span class="n">copy_d</span>
        
        <span class="c1"># get indices of the 5 closest lines</span>
        <span class="k">if</span> <span class="n">flagStdAD</span>  <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">closest_angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">flagStdLLD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">prox_lines</span>     <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">flagLLD</span>    <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">prox_lines</span>     <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">flagPAD</span>    <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">thetas_</span>        <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">flagTAD</span>    <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">mean_angles</span>    <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">flagStdAD</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">flagStdLLD</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">flagLLD</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">flagPAD</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">flagTAD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="c1"># calculate angle of the _&#39;th closest line - MANDATORY</span>
                <span class="n">min_val</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists_to_medpoint</span><span class="p">)</span>
                <span class="n">close_line_ind</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dists_to_medpoint</span> <span class="o">==</span> <span class="n">min_val</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">p0_c</span><span class="p">,</span> <span class="n">p1_c</span>       <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">close_line_ind</span><span class="p">]</span> 
                <span class="n">med_point_c</span>      <span class="o">=</span> <span class="p">((</span><span class="n">p0_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p1_c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">p0_c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p1_c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">center_med_vec_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">med_point_c</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">line_vec_c</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p1_c</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p0_c</span><span class="p">)</span>

                <span class="c1"># ALPHA</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">angle_c</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">center_med_vec_c</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">center_med_vec_c</span><span class="p">),</span> <span class="n">line_vec_c</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">line_vec_c</span><span class="p">)))</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error found in angle_c - arccos&#39;</span><span class="p">)</span>
                    <span class="n">angle_c</span> <span class="o">=</span> <span class="mi">0</span>  
                <span class="k">if</span> <span class="n">angle_c</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span> <span class="n">angle_c</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">-</span> <span class="n">angle_c</span><span class="p">;</span>

                <span class="c1"># THETA</span>

                <span class="k">if</span> <span class="n">p0_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">p1_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> 
                    <span class="n">theta_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">line_vec_c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">line_vec_c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">theta_c</span> <span class="o">=</span> <span class="mi">90</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">theta_c</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">:</span>  <span class="n">theta_c</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">+</span> <span class="n">theta_c</span><span class="p">;</span>

                <span class="c1"># Add to lists</span>
                <span class="k">if</span> <span class="n">flagStdAD</span>  <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">closest_angles</span> <span class="o">=</span> <span class="n">closest_angles</span> <span class="o">+</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">theta</span> <span class="o">-</span> <span class="n">theta_c</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">flagStdLLD</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">flagLLD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">prox_lines</span>     <span class="o">=</span> <span class="n">prox_lines</span> <span class="o">+</span> <span class="p">[</span><span class="n">min_val</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">flagPAD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">thetas_</span>        <span class="o">=</span> <span class="n">thetas_</span> <span class="o">+</span> <span class="p">[</span><span class="n">theta_c</span><span class="p">]</span>


                <span class="c1"># Next line</span>
                <span class="n">dists_to_medpoint</span><span class="p">[</span><span class="n">close_line_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_d</span>
           
        
        <span class="c1"># Add features to list</span>
        <span class="k">if</span> <span class="n">flagAlpha</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">angles</span>      <span class="o">+=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span>
            
        <span class="k">if</span> <span class="n">flagDtC</span>   <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">dist_med</span>    <span class="o">+=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">center_med_vec</span><span class="p">),</span><span class="mi">3</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">flagTri</span>    <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">triangleA</span>   <span class="o">+=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">center_p0</span><span class="p">,</span><span class="n">center_p1</span><span class="p">)),</span><span class="mi">3</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">flagLL</span>     <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line_size</span>   <span class="o">+=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">line_vec</span><span class="p">),</span><span class="mi">3</span><span class="p">)]</span>
       
        <span class="k">if</span> <span class="n">flagTheta</span>  <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">thetas</span>      <span class="o">+=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="mi">3</span><span class="p">)]</span>
            
        <span class="k">if</span> <span class="n">flagStdAD</span>  <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">std_locals</span>  <span class="o">+=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">closest_angles</span><span class="p">),</span><span class="mi">3</span><span class="p">)]</span>
            
        <span class="k">if</span> <span class="n">flagLLD</span>    <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">prox</span>        <span class="o">+=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">prox_lines</span><span class="p">),</span><span class="mi">3</span><span class="p">)]</span>
            
        <span class="k">if</span> <span class="n">flagStdLLD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">std_dists</span>   <span class="o">+=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">prox_lines</span><span class="p">),</span><span class="mi">3</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">flagPAD</span>    <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">PADs</span>        <span class="o">+=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thetas_</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thetas_</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">),</span><span class="mi">3</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">flagTAD</span>    <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">mean_angles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thetas_</span><span class="p">)]</span>  
        
        <span class="k">if</span> <span class="n">flagAG</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">close_angle</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">closest_angles</span><span class="p">),</span><span class="mi">3</span><span class="p">)]</span>
        
        
        
        <span class="c1"># next line</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span>
        
    <span class="c1"># SAVE FEATURES</span>
    <span class="k">if</span> <span class="n">flagAlpha</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:Angles&#39;</span><span class="p">,</span><span class="n">angles</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">flagDtC</span>   <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:Distances to Centroid&#39;</span><span class="p">,</span><span class="n">dist_med</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">flagTri</span>    <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:Triangle Areas&#39;</span><span class="p">,</span><span class="n">triangleA</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">flagLL</span>     <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:Line Lengths&#39;</span><span class="p">,</span><span class="n">line_size</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">flagTheta</span>  <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:Theta&#39;</span><span class="p">,</span><span class="n">thetas</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">flagStdAD</span>  <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:Std. Angle Difference&#39;</span><span class="p">,</span><span class="n">std_locals</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">flagLLD</span>    <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:Local Line Distance&#39;</span><span class="p">,</span><span class="n">prox</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">flagStdLLD</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:Std. Local Line Distance&#39;</span><span class="p">,</span><span class="n">std_dists</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">flagPAD</span>    <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:PAD&#39;</span><span class="p">,</span><span class="n">PADs</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="n">flagAG</span>     <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:Angle Difference&#39;</span><span class="p">,</span><span class="n">close_angle</span><span class="p">)]</span>

    
    <span class="c1"># OOP, HI, Main Vector Magnitude, TAD</span>
    <span class="k">if</span> <span class="s1">&#39;LSF1D:OOP&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">oop</span> <span class="o">=</span> <span class="n">OOP</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF1D:OOP&#39;</span><span class="p">,</span><span class="n">oop</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="s1">&#39;LSF1D:HI&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">hi</span>  <span class="o">=</span> <span class="n">HI</span><span class="p">(</span><span class="n">thetas</span><span class="p">)</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF1D:HI&#39;</span><span class="p">,</span><span class="n">hi</span><span class="p">)]</span>
        
    <span class="k">if</span> <span class="n">flagMCM</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">mcm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">prev_v</span><span class="p">)</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF1D:MCM&#39;</span><span class="p">,</span><span class="n">mcm</span><span class="p">)]</span>
        
    <span class="k">if</span> <span class="s1">&#39;LSF1D:TAD&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">tad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mean_angles</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thetas</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">LSFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF1D:TAD&#39;</span><span class="p">,</span><span class="n">tad</span><span class="p">)]</span>
    
    <span class="c1"># RADIAL SCORE</span>
    <span class="k">if</span> <span class="s1">&#39;LSF1D:Radial Score&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">gridpoints</span>   <span class="o">=</span> <span class="n">subsample_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">mat_scores</span>   <span class="o">=</span> <span class="n">radialscore</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">gridpoints</span><span class="p">,</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">)</span>
        <span class="n">radialSC</span>     <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mat_scores</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">radialSC_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">mat_scores</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mat_scores</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">LSFs</span>  <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF2D:Radial Pos&#39;</span><span class="p">,</span><span class="n">radialSC_pos</span><span class="p">)]</span>
        <span class="n">LSFs</span>  <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;LSF1D:Radial Score&#39;</span><span class="p">,</span><span class="n">radialSC</span><span class="p">)]</span>
    

                                                                                         
    <span class="k">return</span> <span class="n">lines</span><span class="p">,</span> <span class="n">median_points</span><span class="p">,</span> <span class="n">cytocenter</span><span class="p">,</span> <span class="n">LSFs</span></div>


<div class="viewcode-block" id="analyze_cell"><a class="viewcode-back" href="../../framework.html#framework.Processing.analyze_cell">[docs]</a><span class="k">def</span> <span class="nf">analyze_cell</span><span class="p">(</span><span class="n">rowROI</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">algorithm_cyto</span><span class="p">,</span><span class="n">algorithm_nuclei</span><span class="p">,</span><span class="n">LSFparams</span><span class="p">,</span><span class="n">features</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # rowROI - dataframe with specific ROI corresponding to a cell</span>
<span class="sd">    # data   - data with any key:</span>
<span class="sd">                  # - RGB</span>
<span class="sd">                  # - CYTO_DECONV with algorithm CYTO_DECONV</span>
<span class="sd">                  # - NUCL_DECONV with algorithm NUCL_PRE</span>
<span class="sd">                  # - </span>
<span class="sd">    &quot;&quot;&quot;</span>
                    
    <span class="c1"># Useful variables:</span>
    <span class="n">img_id</span>  <span class="o">=</span> <span class="n">rowROI</span><span class="p">[</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span>
    <span class="n">name</span>    <span class="o">=</span> <span class="n">rowROI</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
    <span class="n">label</span>   <span class="o">=</span> <span class="n">label_image</span><span class="p">(</span><span class="n">img_id</span><span class="p">)</span>
    
    <span class="c1"># 1040 x 1388</span>
    <span class="n">mask</span>    <span class="o">=</span> <span class="n">rowROI</span><span class="p">[</span><span class="s1">&#39;ROImask&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">algorithm_cyto</span> <span class="o">==</span> <span class="s1">&#39;deconvoluted&#39;</span><span class="p">:</span>
        <span class="n">cdeconv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CYTO_DECONV&#39;</span><span class="p">][</span><span class="s1">&#39;Image&#39;</span><span class="p">][</span><span class="n">img_id</span><span class="p">]</span>
        <span class="n">ndeconv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NUCL_DECONV&#39;</span><span class="p">][</span><span class="s1">&#39;Image&#39;</span><span class="p">][</span><span class="n">img_id</span><span class="p">]</span>
        
        <span class="n">cyto</span>        <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">cdeconv</span>
        <span class="n">cyto_norm</span>   <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">cdeconv</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cdeconv</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cyto</span><span class="p">)</span> <span class="c1">#aux_f</span>
        <span class="n">ndeconv</span>         <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">ndeconv</span>
        <span class="n">mndeconv_norm</span>   <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndeconv</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ndeconv</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ndeconv</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">algorithm_cyto</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="n">rgb</span>     <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RGB&#39;</span><span class="p">][</span><span class="s1">&#39;Image&#39;</span><span class="p">][</span><span class="n">img_id</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rgb</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cyto</span>  <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span> <span class="c1">#aux_f</span>
        <span class="n">cyto_norm</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">cyto</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cyto</span><span class="p">))</span>
        
         
    <span class="n">esqueleto</span>       <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CYTO_PRE&#39;</span><span class="p">][</span><span class="s1">&#39;Skeleton&#39;</span><span class="p">][</span><span class="n">img_id</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span>
    <span class="n">mesqueleto</span>      <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">esqueleto</span>                              <span class="c1"># aux_</span>
    
    <span class="k">if</span> <span class="n">algorithm_cyto</span> <span class="o">==</span> <span class="s1">&#39;deconvoluted&#39;</span><span class="p">:</span>
        <span class="n">mesqueleto_int</span>  <span class="o">=</span> <span class="n">mesqueleto</span> <span class="o">*</span> <span class="n">cdeconv</span>
        <span class="n">mesqueleto_norm</span> <span class="o">=</span> <span class="n">mesqueleto</span> <span class="o">*</span> <span class="p">(</span><span class="n">cdeconv</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cdeconv</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cyto</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">algorithm_cyto</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="n">mesqueleto_int</span>  <span class="o">=</span> <span class="n">mesqueleto</span> <span class="o">*</span> <span class="n">orig_cysk</span>
        <span class="n">mesqueleto_norm</span> <span class="o">=</span> <span class="n">mesqueleto</span> <span class="o">*</span> <span class="n">orig_cysk</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">orig_cysk</span><span class="p">)</span> 
        
        
    <span class="c1"># SKELETON PATCH</span>
    <span class="k">global</span> <span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">,</span><span class="n">patch</span>
    <span class="n">x_</span><span class="p">,</span><span class="n">y_</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mesqueleto</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#x_,y_   = np.where((mask*1) != 0) QUAL??</span>
    <span class="n">patch</span>   <span class="o">=</span> <span class="n">mesqueleto</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">x_</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">x_</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">y_</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">y_</span><span class="p">)]</span>
    
    <span class="c1"># DECONVOLUTED CYTOSKELETON PATCH</span>
    <span class="k">global</span> <span class="n">x_f</span><span class="p">,</span><span class="n">y_f</span><span class="p">,</span><span class="n">patch_f</span><span class="p">,</span><span class="n">aux_f</span>      <span class="c1">#  = </span>
    <span class="n">x_f</span><span class="p">,</span><span class="n">y_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cyto_norm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">patch_f_norm</span> <span class="o">=</span> <span class="n">cyto_norm</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">x_f</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">x_f</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">y_f</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">y_f</span><span class="p">)]</span>
    <span class="c1">#patch_f_norm = patch_f / np.max(patch_f)</span>
    
    <span class="c1"># GET and PLOT centroid</span>
    <span class="n">centroid_id</span><span class="p">,</span><span class="n">centroid</span> <span class="o">=</span> <span class="n">ROI_centroid</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">img_id</span><span class="p">,[</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">])</span>
     
    <span class="c1"># Deconvoluted nuclei patch</span>
    <span class="k">if</span> <span class="n">algorithm_cyto</span> <span class="o">==</span> <span class="s1">&#39;deconvoluted&#39;</span><span class="p">:</span>
        <span class="n">aux_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ndeconv</span><span class="p">)</span>
        <span class="n">rownuc</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NUCL_PRE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">centroid_id</span><span class="p">]</span>
        
        <span class="c1">#a = list(zip(rownuc[&#39;Nucleus Mask&#39;][0],rownuc[&#39;Nucleus Mask&#39;][1]))</span>
        <span class="n">aux_n</span><span class="p">[</span><span class="n">rownuc</span><span class="p">[</span><span class="s1">&#39;Nucleus Mask&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">rownuc</span><span class="p">[</span><span class="s1">&#39;Nucleus Mask&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="n">aux_n_</span> <span class="o">=</span> <span class="n">aux_n</span> <span class="o">*</span> <span class="n">ndeconv</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ndeconv</span><span class="p">)</span>
        <span class="n">aux_n_</span> <span class="o">=</span> <span class="n">aux_n_</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">aux_n_</span><span class="p">)</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">contourr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NUCL_PRE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">centroid_id</span><span class="p">][</span><span class="s1">&#39;Contour&#39;</span><span class="p">]</span> 
            <span class="n">cr</span>       <span class="o">=</span> <span class="n">contourr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">contourr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">contourr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">contourr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NUCL_PRE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">centroid_id</span><span class="p">][</span><span class="s1">&#39;Contour&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cr</span>       <span class="o">=</span> <span class="n">contourr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">contourr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">contourr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        
<span class="c1">#     patch_n  = aux_n[min(cr[:,1]):max(cr[:,1]),min(cr[:,0]):max(cr[:,0])]</span>
<span class="c1">#     patch_n_norm = patch_n / np.max(aux_n)</span>
    <span class="n">patch_n_norm</span> <span class="o">=</span> <span class="n">aux_n_</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">rownuc</span><span class="p">[</span><span class="s1">&#39;Nucleus Mask&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span><span class="nb">max</span><span class="p">(</span><span class="n">rownuc</span><span class="p">[</span><span class="s1">&#39;Nucleus Mask&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="nb">min</span><span class="p">(</span><span class="n">rownuc</span><span class="p">[</span><span class="s1">&#39;Nucleus Mask&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span><span class="nb">max</span><span class="p">(</span><span class="n">rownuc</span><span class="p">[</span><span class="s1">&#39;Nucleus Mask&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
<span class="c1">#     patch_n_norm = patch_n_norm = patch_n / np.max(aux_n)</span>
    
<span class="c1">#     # PROCESSING: LINE SEGMENT ANALYSIS</span>
    <span class="n">lines</span><span class="p">,</span> <span class="n">median_points</span><span class="p">,</span> <span class="n">cytocenter</span><span class="p">,</span> <span class="n">LSFs</span> <span class="o">=</span> <span class="n">line_segment_features</span><span class="p">(</span><span class="n">features</span><span class="p">,</span><span class="n">mesqueleto</span><span class="p">,</span><span class="n">img_id</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">patch</span><span class="p">,(</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">),</span><span class="n">centroid</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
    

    <span class="c1"># PROCESSING: **CYTOSKELETONS**</span>
    <span class="n">feats_all</span>                    <span class="o">=</span> <span class="n">ImageFeatures</span><span class="p">((</span><span class="n">patch_f_norm</span> <span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span><span class="n">mesqueleto_norm</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">x_</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">x_</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">y_</span><span class="p">):</span><span class="nb">max</span><span class="p">(</span><span class="n">y_</span><span class="p">)],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;CYTO_DECONV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="s1">&#39;Path&#39;</span><span class="p">])</span>
    <span class="n">feats_labels_</span><span class="p">,</span> <span class="n">feats_values_</span> <span class="o">=</span> <span class="n">feats_all</span><span class="o">.</span><span class="n">print_features</span><span class="p">(</span><span class="n">print_values</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">feats_labels_</span><span class="p">,</span> <span class="n">feats_values_</span> <span class="o">=</span> <span class="n">remove_not1D</span><span class="p">(</span><span class="n">feats_labels_</span><span class="p">,</span><span class="n">feats_values_</span><span class="p">)</span>
    <span class="n">feats_labels_</span>                <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DCF:&#39;</span> <span class="o">+</span> <span class="n">ftf</span> <span class="k">for</span> <span class="n">ftf</span> <span class="ow">in</span> <span class="n">feats_labels_</span><span class="p">]</span>
 
    <span class="c1"># PROCESSING: **NUCLEI**</span>
    <span class="n">feats_all_n</span>                      <span class="o">=</span> <span class="n">ImageFeatures</span><span class="p">((</span><span class="n">patch_n_norm</span> <span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span><span class="kc">None</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;NUCL_DECONV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">img_id</span><span class="p">][</span><span class="s1">&#39;Path&#39;</span><span class="p">])</span>
    <span class="n">feats_labels_n_</span><span class="p">,</span> <span class="n">feats_values_n_</span> <span class="o">=</span> <span class="n">feats_all_n</span><span class="o">.</span><span class="n">print_features</span><span class="p">(</span><span class="n">print_values</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">feats_labels_n_</span><span class="p">,</span> <span class="n">feats_values_n_</span> <span class="o">=</span> <span class="n">remove_not1D</span><span class="p">(</span><span class="n">feats_labels_n_</span><span class="p">,</span><span class="n">feats_values_n_</span><span class="p">)</span>
    <span class="n">feats_labels_n_</span>                  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DNF:&#39;</span> <span class="o">+</span> <span class="n">ftn</span> <span class="k">for</span> <span class="n">ftn</span> <span class="ow">in</span> <span class="n">feats_labels_n_</span><span class="p">]</span>
    
<span class="c1">#     # PROCESSING: Graph Analysis</span>
    <span class="k">global</span> <span class="n">int_ske</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">graph_res</span><span class="p">,</span> <span class="n">shollhist</span><span class="p">,</span> <span class="n">cncd</span><span class="p">,</span> <span class="n">pxlcount</span>
    <span class="c1">#int_ske         = (mesqueleto * aux_f) / np.max(aux_f) </span>
    <span class="n">graph</span><span class="p">,</span><span class="n">graph_res</span><span class="p">,</span><span class="n">shollhist</span> <span class="o">=</span> <span class="n">cyto_graph_features</span><span class="p">(</span><span class="n">mesqueleto_norm</span><span class="p">,</span><span class="n">features</span><span class="p">,[</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">],[</span><span class="n">aux_n_</span><span class="p">,</span><span class="n">centroid</span><span class="p">,</span><span class="n">cr</span><span class="p">],</span><span class="n">mask</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
    
<span class="c1">#     # PROCESSING: Others</span>
<span class="c1">#     cncd = Others(aux_f,aux_n,lines)</span>

    <span class="c1"># Add to DataFrame</span>
    <span class="k">global</span> <span class="n">ResultsDF</span><span class="p">,</span><span class="n">new</span>
    <span class="k">if</span> <span class="s1">&#39;ResultsDF&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
        <span class="n">ResultsDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Img Index&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Label&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Mask&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Patches&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Nucleus Contour&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Nucleus Centroid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Cytoskeleton Centroid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Lines&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">LSFs</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">feats_labels_n_</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">xg</span> <span class="k">for</span> <span class="n">xg</span><span class="p">,</span><span class="n">yg</span> <span class="ow">in</span> <span class="n">graph_res</span><span class="p">])</span>
        
    <span class="n">new</span>       <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">img_id</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">+</span> <span class="p">[[</span><span class="n">patch</span><span class="p">,</span><span class="n">patch_f_norm</span><span class="p">,</span><span class="n">patch_n_norm</span><span class="p">,</span><span class="n">mesqueleto</span><span class="p">,</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">cr</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">centroid</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">cytocenter</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">lines</span><span class="p">]</span> <span class="o">+</span>  <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">LSFs</span><span class="p">]</span> <span class="o">+</span> <span class="n">feats_values_n_</span> <span class="o">+</span> <span class="p">[</span><span class="n">yg</span> <span class="k">for</span> <span class="n">xg</span><span class="p">,</span><span class="n">yg</span> <span class="ow">in</span> <span class="n">graph_res</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">ResultsDF</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="n">ResultsDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ResultsDF</span><span class="p">,</span><span class="n">new</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
         
    
    <span class="k">return</span> <span class="n">ResultsDF</span></div>


<span class="c1"># # Analyze Cell</span>
<span class="c1"># def analyze_cell_old(text_img,mask,hough_params,centroids,OriginalDF,DeconvDF,NucleiDeconvDF,algorithm,plot):</span>
<span class="c1">#     # INPUTS:</span>
<span class="c1">#     # text_img                             = [skeleton, index,texture w/ intensity]</span>
<span class="c1">#     # mask                                 = binary mask</span>
<span class="c1">#     # hough_params                         = [thr, line length, line gap]</span>
<span class="c1">#     # centroids                            = DataFrame with nuclei ID&#39;s, masks, centroids and contours from image</span>
<span class="c1">#     # OriginalDF, DeconvDF, NucleiDeconvDF = Datasets</span>
<span class="c1">#     # plot                                 = True/False</span>
    
<span class="c1">#     global orig_cysk</span>
<span class="c1">#     tmp        = copy.deepcopy(OriginalDF[&#39;Image&#39;][text_img[1]])</span>
<span class="c1">#     tmp[:,:,0] = 0</span>
<span class="c1">#     orig_cysk  = cv2.cvtColor(tmp,cv2.COLOR_RGB2GRAY)</span>
    
<span class="c1">#     global patch_aux,centroid,cr,patch_n,centroid</span>
    
    
<span class="c1">#     # Texture patch for Hough Analysis</span>
<span class="c1">#     global x_,y_,patch,aux_</span>
<span class="c1">#     aux_    = mask * (text_img[0] * 1)</span>
<span class="c1">#     x_,y_   = np.where((mask*1) != 0)</span>
<span class="c1">#     patch   = aux_[min(x_):max(x_),min(y_):max(y_)]</span>
    
<span class="c1">#     # Deconvoluted cytoskeleton patch </span>
<span class="c1">#     global x_f,y_f,patch_f,aux_f</span>
<span class="c1">#     if algorithm == &#39;deconvoluted&#39;:</span>
<span class="c1">#         aux_f   = mask * (DeconvDF[&#39;Image&#39;][text_img[1]] / np.max(DeconvDF[&#39;Image&#39;][text_img[1]]))</span>
<span class="c1">#     if algorithm == &#39;original&#39;:</span>
<span class="c1">#         aux_f   = mask * (orig_cysk / np.max(orig_cysk))</span>
<span class="c1">#     x_f,y_f = np.where(aux_f != 0)</span>
<span class="c1">#     patch_f = aux_f[min(x_f):max(x_f),min(y_f):max(y_f)]</span>
     
        
<span class="c1">#     # PROCESSING: Line Segment Analysis</span>
<span class="c1">#     global lines, median_points, centroid_list, centroid, features2D, features1D</span>
<span class="c1">#     lines, median_points, centroid_list, centroid, features2D, features1D = line_segment_features(text_img[0],text_img[1],mask,patch,(x_,y_),centroids,plot)</span>
    

<span class="c1">#     # Deconvoluted nuclei patch</span>
<span class="c1">#     if algorithm == &#39;deconvoluted&#39;:</span>
<span class="c1">#         aux_n    = mask * (NucleiDeconvDF[&#39;Image&#39;][text_img[1]] / np.max(NucleiDeconvDF[&#39;Image&#39;][text_img[1]]))</span>
<span class="c1">#     if algorithm == &#39;original&#39;:</span>
<span class="c1">#         aux_n    = mask * (OriginalDF[&#39;Image&#39;][text_img[1]][:,:,0] / np.max(OriginalDF[&#39;Image&#39;][text_img[1]][:,:,0]))</span>
    
<span class="c1">#     try:</span>
<span class="c1">#         contourr = centroids.loc[centroid_list[0]][&#39;Contour&#39;] </span>
<span class="c1">#         cr       = contourr.reshape((contourr.shape[0],contourr.shape[2]))</span>
<span class="c1">#     except:</span>
<span class="c1">#         contourr = centroids.loc[centroid_list[0]][&#39;Contour&#39;][0]</span>
<span class="c1">#         cr       = contourr.reshape((contourr.shape[0],contourr.shape[2]))</span>
<span class="c1">#     patch_n  = aux_n[min(cr[:,1]):max(cr[:,1]),min(cr[:,0]):max(cr[:,0])]</span>

  
<span class="c1">#     # TEXTURAL ANALYSIS</span>
    
<span class="c1">#     # AAI</span>
<span class="c1">#     #global AAI</span>
<span class="c1">#     #AAI = getAAI(patch_f)</span>
<span class="c1">#     AAI = 0</span>
    
<span class="c1">#     # PROCESSING: **CYTOSKELETONS**</span>
<span class="c1">#     b,d              = fractal_dimension_grayscale(patch_f)</span>
<span class="c1">#     fractal_values_b = [round(b,3)]</span>
<span class="c1">#     fractal_values_d = [round(d,3)]</span>
<span class="c1">#     fdske            = [round(fractal_dimension(patch),3)]</span>
        
<span class="c1">#     feats_all                    = ImageFeatures((patch_f *255).astype(np.uint8))</span>
<span class="c1">#     feats_labels_, feats_values_ = feats_all.print_features(print_values = False)</span>
<span class="c1">#     feats_labels_, feats_values_ = remove_not1D(feats_labels_,feats_values_)</span>
<span class="c1">#     feats_labels_                = [&#39;DCF:&#39; + ftf for ftf in feats_labels_]</span>
 
<span class="c1">#     # PROCESSING: **NUCLEI**</span>
<span class="c1">#     b_n,d_n = fractal_dimension_grayscale(patch_n)</span>
<span class="c1">#     fractal_values_n_b = [round(b_n)]</span>
<span class="c1">#     fractal_values_n_d = [round(d_n)]         </span>
    
<span class="c1">#     feats_all_n                      = ImageFeatures((patch_n *255).astype(np.uint8))</span>
<span class="c1">#     feats_labels_n_, feats_values_n_ = feats_all_n.print_features(print_values = False)</span>
<span class="c1">#     feats_labels_n_, feats_values_n_ = remove_not1D(feats_labels_n_,feats_values_n_)</span>
<span class="c1">#     feats_labels_n_                  = [&#39;DNF:&#39; + ftn for ftn in feats_labels_n_]</span>
    
<span class="c1">#     # PROCESSING: Graph Analysis</span>
<span class="c1">#     int_ske         = ((text_img[0] * 1) * aux_f) / np.max(patch_f) #1040x1388</span>
<span class="c1">#     graph,graph_res = graphAnalysis(int_ske,[x_,y_],[aux_n / np.max(patch_n),centroid,cr],mask,plot)</span>
    
<span class="c1">#     # PROCESSING: Others</span>
<span class="c1">#     cncd = Others(aux_f,aux_n,lines)</span>
    
    
<span class="c1">#     # Add to DataFrame</span>
<span class="c1">#     global ImageLinesDF,new</span>
<span class="c1">#     if &#39;ImageLinesDF&#39; not in globals():</span>
<span class="c1">#             ImageLinesDF = pd.DataFrame(columns = [&#39;Name&#39;] + [&#39;Img Index&#39;] + [&#39;Label&#39;] + [&#39;Mask&#39;] + [&#39;Patches&#39;] + [&#39;Lines&#39;] + [&#39;Graph&#39;] + [x for x,y in features2D] + [xe for xe,ye in features1D] + [&#39;DCF:AAI&#39;] + [&#39;DCF:Fractal Dim B&#39;] + [&#39;DCF:Fractal Dim D&#39;] + [&#39;DCF:Fractal Dim Skeleton&#39;] + list(feats_labels_) + [&#39;DNF:Nuclei Fractal Dim B&#39;] + [&#39;DNF:Nuclei Fractal Dim D&#39;] + list(feats_labels_n_) + [graph_ft for graph_ft in list(zip(*graph_res))[0]] + [x for x,y in cncd])</span>
<span class="c1">#     new          = pd.Series([DeconvDF[&#39;Name&#39;][text_img[1]]] + [text_img[1]] + [DeconvDF[&#39;Label&#39;][text_img[1]]] + [mask] + [[patch,patch_f,patch_n]] + [lines] + [[graph]] + [y for x,y in features2D] + [ye for xe,ye in features1D] + [AAI] + fractal_values_b + fractal_values_d + fdske + feats_values_ + fractal_values_n_b + fractal_values_n_d + feats_values_n_ + [graph_ft for graph_ft in list(zip(*graph_res))[1]] + [y for x,y in cncd],index=ImageLinesDF.columns)</span>
<span class="c1">#     ImageLinesDF = ImageLinesDF.append(new,ignore_index=True)</span>
        

<span class="c1">#     return ImageLinesDF,mask,patch,x_,y_,patch_f,patch_n</span>






<div class="viewcode-block" id="cyto_graph_features"><a class="viewcode-back" href="../../framework.html#framework.Processing.cyto_graph_features">[docs]</a><span class="k">def</span> <span class="nf">cyto_graph_features</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="n">features</span><span class="p">,</span><span class="n">infocyto</span><span class="p">,</span><span class="n">infonucl</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">plot</span><span class="p">):</span> <span class="c1">#old graphanalysis</span>
    <span class="k">global</span> <span class="n">skeleton</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # infocyto = [x_,y_]</span>
<span class="sd">    # infonucl = [NucleiDeconvDF[&#39;Image&#39;][row[&#39;Index&#39;]],centroid,cr] </span>
<span class="sd">    #graph = sknw.build_sknw(skeleton,multi=False,**[{&#39;iso&#39;:False}])</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert skeleton to skeleton object</span>
    <span class="n">ske</span> <span class="o">=</span> <span class="n">Skeleton</span><span class="p">((</span><span class="n">sk</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span> 
    
    <span class="c1"># Get branch data:</span>
    <span class="n">branch_data</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">ske</span><span class="p">,</span><span class="n">find_main_branch</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># Create feature list</span>
    <span class="n">CNFs</span> <span class="o">=</span> <span class="p">[]</span>
    
    
    <span class="c1"># FEATURE: Number of paths (1D):</span>
    <span class="k">if</span> <span class="s1">&#39;SKNW1D:Number of Branches&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">Npaths</span> <span class="o">=</span> <span class="n">ske</span><span class="o">.</span><span class="n">n_paths</span>
        <span class="n">CNFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;SKNW1D:Number of Branches&#39;</span><span class="p">,</span><span class="n">Npaths</span><span class="p">)]</span>
    
    <span class="c1"># FEATURE: Branch distance, Mean/Std Pixel Values, Eucl distance</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;branch-distance&#39;</span><span class="p">,</span><span class="s1">&#39;mean-pixel-value&#39;</span><span class="p">,</span><span class="s1">&#39;stdev-pixel-value&#39;</span><span class="p">,</span><span class="s1">&#39;euclidean-distance&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">names</span>    <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">signal_stats</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">branch_data</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span><span class="o">.</span><span class="n">_names</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tools</span><span class="o">.</span><span class="n">signal_stats</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">branch_data</span><span class="p">[</span><span class="n">col</span><span class="p">]))))</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;SKNW1D:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">names</span><span class="p">],</span><span class="n">features</span><span class="p">))</span>
    
    
    <span class="c1"># Path grouping</span>
    <span class="n">br_type_nams</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Endpoint-to-endpoint (isolated branch)&#39;</span><span class="p">,</span><span class="s1">&#39;Junction-to-endpoints&#39;</span><span class="p">,</span><span class="s1">&#39;Junction-to-junctions&#39;</span><span class="p">,</span><span class="s1">&#39;Isolated cycles&#39;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">branch_data</span><span class="p">[</span><span class="s1">&#39;branch-type&#39;</span><span class="p">]):</span>
        <span class="n">br_type_data</span> <span class="o">=</span> <span class="n">branch_data</span><span class="p">[</span><span class="n">branch_data</span><span class="p">[</span><span class="s1">&#39;branch-type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">typ</span><span class="p">]</span>
        
        <span class="n">CNFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;SKNW1D:Number of &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">br_type_nams</span><span class="p">[</span><span class="n">typ</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">br_type_data</span><span class="p">)),</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;SKNW1D:Ratio of &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">br_type_nams</span><span class="p">[</span><span class="n">typ</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">br_type_data</span><span class="p">)</span><span class="o">/</span><span class="n">Npaths</span><span class="p">)]</span>
        
        <span class="k">for</span> <span class="n">col_</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">CNFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;SKNW1D:Mean of &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">br_type_nams</span><span class="p">[</span><span class="n">typ</span><span class="p">])</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">br_type_data</span><span class="p">[</span><span class="n">col_</span><span class="p">])),</span>
                    <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;SKNW1D:Std of &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">br_type_nams</span><span class="p">[</span><span class="n">typ</span><span class="p">])</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">br_type_data</span><span class="p">[</span><span class="n">col_</span><span class="p">]))]</span>
            
    <span class="c1"># Handle Isolated cycles</span>
    <span class="k">if</span> <span class="mi">3</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">branch_data</span><span class="p">[</span><span class="s1">&#39;branch-type&#39;</span><span class="p">]):</span> 
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">branch_data</span><span class="p">[</span><span class="n">branch_data</span><span class="p">[</span><span class="s1">&#39;branch-type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="n">CNFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;SKNW1D:Number of &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">br_type_nams</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;SKNW1D:Ratio of &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">br_type_nams</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="mi">0</span><span class="p">)]</span>
        
        <span class="k">for</span> <span class="n">col_</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">CNFs</span> <span class="o">+=</span> <span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;SKNW1D:Mean of &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">br_type_nams</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;SKNW1D:Std of &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">br_type_nams</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_</span><span class="p">),</span><span class="mi">0</span><span class="p">)]</span>
        
    <span class="c1">#br_type_lens = [len(branch_data[branch_data[&#39;branch-type&#39;] == typ]) for typ in np.unique(branch_data[&#39;branch-type&#39;] )]</span>
    

    
    
<span class="c1">#     graph = sknw.build_sknw(sk)</span>
    
<span class="c1">#     # Get branch sizes and turtuosity</span>
<span class="c1">#     sizes = []</span>
<span class="c1">#     eucl  = []</span>
<span class="c1">#     global s,e,ps,ps_</span>
<span class="c1">#     for (s,e) in graph.edges():</span>
<span class="c1">#         ps = graph[s][e][&#39;pts&#39;]</span>
<span class="c1">#         sizes += [len(ps)]</span>
        
<span class="c1">#         minx,maxx,miny,maxy = min(ps[:,0]),max(ps[:,0]),min(ps[:,1]),max(ps[:,1])</span>
<span class="c1">#         eucl += [np.sqrt((maxx - minx)**2 + (maxy - miny)**2)]</span>

<span class="c1">#     # PLOT</span>
<span class="c1">#     if plot:</span>
<span class="c1">#         plt.figure(figsize=(15,15))</span>
<span class="c1">#         plt.imshow(np.zeros_like(sk), cmap=&#39;gray&#39;)</span>
<span class="c1">#         # draw edges by pts</span>
<span class="c1">#         for (s,e) in graph.edges():</span>
<span class="c1">#             ps = graph[s][e][&#39;pts&#39;]</span>
<span class="c1">#             plt.plot(ps[:,1], ps[:,0], &#39;white&#39;)</span>
<span class="c1">#         # draw node by o</span>
<span class="c1">#         nodes = graph.nodes()</span>
<span class="c1">#         ps_ = np.array([nodes[i][&#39;o&#39;] for i in nodes])</span>
<span class="c1">#         plt.plot(ps_[:,1], ps_[:,0], &#39;r.&#39;)</span>
<span class="c1">#         plt.title(&#39;Cytoskeleton Graph&#39;)</span>
<span class="c1">#         plt.axis(&#39;off&#39;)</span>
<span class="c1">#         plt.show()</span>
        
    <span class="c1">#pixel_graph, coordinates = skeleton_to_csgraph(skeleton * DeconvDF[&#39;Image&#39;][row[&#39;Index&#39;]])</span>
    
<span class="c1">#     skeleton_to_csgraph</span>
<span class="c1">#     branch_data = summarize(ske)</span>
    
<span class="c1">#     sizes = ske.path_lengths()</span>
<span class="c1">#     med_int = ske.path_means()</span>
<span class="c1">#     std_int = ske.path_stdev()</span>
    
    <span class="c1"># Branch Analysis</span>
    <span class="c1">#branch_feats = branch(sk,ske,[infocyto[0],infocyto[1]],[mask * infonucl[0],infonucl[1],infonucl[2]])</span>
                   
    <span class="c1"># Sholl Analysis</span>
    <span class="n">sholl_feats</span><span class="p">,</span><span class="n">sholl_hist</span> <span class="o">=</span> <span class="n">sholl</span><span class="p">(</span><span class="n">sk</span><span class="p">,[</span><span class="n">infocyto</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">infocyto</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">mask</span> <span class="o">*</span> <span class="n">infonucl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">infonucl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">infonucl</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">plot</span><span class="p">)</span>
    
    <span class="c1">#G = nx.from_scipy_sparse_matrix(pixel_graph)  ou nx.from_scipy_sparse_matrix(ske.graph) representao N+1??? nx.density</span>
    
    <span class="k">return</span> <span class="n">ske</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span><span class="n">branch_feats</span> <span class="o">+</span> <span class="n">sholl_feats</span><span class="p">,</span><span class="n">sholl_hist</span></div>



    
<span class="c1">#r = branch(ske,[x_,y_],[row[&#39;ROImask&#39;] * NucleiDeconvDF[&#39;Image&#39;][row[&#39;Index&#39;]],centroid,cr],False)</span>


<div class="viewcode-block" id="sholl"><a class="viewcode-back" href="../../framework.html#framework.Processing.sholl">[docs]</a><span class="k">def</span> <span class="nf">sholl</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">cyto_info</span><span class="p">,</span><span class="n">nuclei_info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    #img         = skeleton img intensified   #img = skeleton * DeconvDF[&#39;Image&#39;][row[&#39;Index&#39;]]</span>
<span class="sd">    # cyto info  = [x_,y_]</span>
<span class="sd">    #nuclei info = [nuclei img   , centroid,contour (cr)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Get cytoskeleton centroid</span>
    <span class="n">cytoCentroid</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">((</span><span class="n">img</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span><span class="n">img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span> <span class="c1">#without offset</span>
    
    <span class="c1"># Get skeleton object</span>
    <span class="n">ske</span> <span class="o">=</span> <span class="n">Skeleton</span><span class="p">((</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
    
    <span class="c1"># Get max radii and radii vector</span>
    <span class="n">maxradii</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">nuclei_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">nuclei_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">nuclei_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">nuclei_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">nuclei_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">nuclei_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">nuclei_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">nuclei_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])))]),</span>
                   <span class="nb">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">cytoCentroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">cytoCentroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">cytoCentroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">cytoCentroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">cytoCentroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">cytoCentroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">cytoCentroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">cytoCentroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">cyto_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])))]))</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">maxradii</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1">#global center_Cy,shell_radii_Cy,counts_Cy,center_Nc,shell_radii_Nc,counts_Nc</span>
    <span class="n">center_Cy</span><span class="p">,</span><span class="n">shell_radii_Cy</span><span class="p">,</span><span class="n">counts_Cy</span> <span class="o">=</span> <span class="n">sholl_analysis</span><span class="p">(</span><span class="n">ske</span><span class="p">,</span> <span class="n">shells</span><span class="o">=</span><span class="n">radii</span><span class="p">,</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">cytoCentroid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cytoCentroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">center_Nc</span><span class="p">,</span><span class="n">shell_radii_Nc</span><span class="p">,</span><span class="n">counts_Nc</span> <span class="o">=</span> <span class="n">sholl_analysis</span><span class="p">(</span><span class="n">ske</span><span class="p">,</span> <span class="n">shells</span><span class="o">=</span><span class="n">radii</span><span class="p">,</span><span class="n">center</span> <span class="o">=</span> <span class="n">nuclei_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Build table</span>
    <span class="n">tableCy</span>     <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">shell_radii_Cy</span><span class="p">,</span> <span class="s1">&#39;crossings&#39;</span><span class="p">:</span> <span class="n">counts_Cy</span><span class="p">})</span>
    <span class="n">tableNc</span>     <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">shell_radii_Nc</span><span class="p">,</span> <span class="s1">&#39;crossings&#39;</span><span class="p">:</span> <span class="n">counts_Nc</span><span class="p">})</span>
    
    <span class="n">fts</span>         <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">signal_stats</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tableCy</span><span class="p">[</span><span class="s1">&#39;crossings&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">_names</span>
    <span class="n">tempCy</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tools</span><span class="o">.</span><span class="n">signal_stats</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tableCy</span><span class="p">[</span><span class="s1">&#39;crossings&#39;</span><span class="p">]))))</span>
    <span class="n">tempNc</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tools</span><span class="o">.</span><span class="n">signal_stats</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tableNc</span><span class="p">[</span><span class="s1">&#39;crossings&#39;</span><span class="p">]))))</span>
    
    <span class="n">sholl_feats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;SKNW1D:Sholl Crossings Cyto &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fts</span><span class="p">],</span><span class="n">tempCy</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;SKNW1D:Sholl Crossings Nuclei &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fts</span><span class="p">],</span><span class="n">tempNc</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">sholl_feats</span><span class="p">,[</span><span class="n">tableCy</span><span class="p">,</span><span class="n">tableNc</span><span class="p">]</span></div>
                   


<div class="viewcode-block" id="newtheta"><a class="viewcode-back" href="../../framework.html#framework.Processing.newtheta">[docs]</a><span class="k">def</span> <span class="nf">newtheta</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">thetas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="o">=</span> <span class="n">line</span>
        <span class="n">line_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1">#theta = np.arctan(abs(p1[1]-p0[1])/abs(p1[0]-p0[0]))*180/np.pi</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">line_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">line_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="mi">90</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">:</span>  <span class="n">theta</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">+</span> <span class="n">theta</span><span class="p">;</span>

        <span class="n">thetas</span> <span class="o">+=</span> <span class="p">[</span><span class="n">theta</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">thetas</span></div>



<div class="viewcode-block" id="Others"><a class="viewcode-back" href="../../framework.html#framework.Processing.Others">[docs]</a><span class="k">def</span> <span class="nf">Others</span><span class="p">(</span><span class="n">img_cyto</span><span class="p">,</span><span class="n">img_nucl</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>
    <span class="c1"># Cyto-Nuc Centroid Divergence:</span>
    <span class="n">rprops_cyto</span><span class="p">,</span><span class="n">rprops_nucl</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">((</span><span class="n">img_cyto</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span><span class="n">img_cyto</span><span class="p">),</span><span class="n">regionprops</span><span class="p">((</span><span class="n">img_nucl</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span><span class="n">img_nucl</span><span class="p">)</span>
    <span class="n">centro_cyto</span><span class="p">,</span><span class="n">centro_nucl</span> <span class="o">=</span> <span class="n">rprops_cyto</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="p">,</span><span class="n">rprops_nucl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span>
    <span class="n">w_centro_cyto</span><span class="p">,</span><span class="n">w_centro_nucl</span> <span class="o">=</span> <span class="n">rprops_cyto</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weighted_centroid</span><span class="p">,</span><span class="n">rprops_nucl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weighted_centroid</span>

    <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;OTHERS:Cytoskeleton-Nuclei Centroid Distance&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">centro_cyto</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">centro_nucl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">centro_cyto</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">centro_nucl</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span>
            <span class="p">(</span><span class="s1">&#39;OTHERS:Weighted Cytoskeleton-Nuclei Centroid Distance&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">w_centro_cyto</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">w_centro_nucl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">w_centro_cyto</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">w_centro_nucl</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span>
            <span class="p">(</span><span class="s1">&#39;OTHERS:Area Ratio (Cyto vs. Nucl)&#39;</span><span class="p">,</span><span class="n">rprops_nucl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span><span class="o">/</span><span class="n">rprops_cyto</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span><span class="p">)]</span></div>

<div class="viewcode-block" id="HI"><a class="viewcode-back" href="../../framework.html#framework.Processing.HI">[docs]</a><span class="k">def</span> <span class="nf">HI</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
    <span class="n">theta_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
    <span class="n">bins</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hist</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hist</span>      <span class="o">=</span> <span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">hist</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">#hist      = (hist[0], [(hist[1][i] + hist[1][i+1])/2 for i in range(len(hist[1])-1)])</span>

    <span class="k">def</span> <span class="nf">get_index_hist1</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">hist1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">hist1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">theta</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hist1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">theta</span> <span class="o">&gt;</span> <span class="n">hist1</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">count</span>
    
    <span class="k">def</span> <span class="nf">mylog</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    
    <span class="n">inds</span>  <span class="o">=</span> <span class="p">[</span><span class="n">get_index_hist1</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">hist</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">theta_rad</span><span class="p">]</span>
    <span class="n">ent</span>   <span class="o">=</span> <span class="p">[</span><span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">]</span>
    <span class="n">xlogx</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">mylog</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ent</span><span class="p">]</span>
    <span class="n">HI</span>    <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xlogx</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">HI</span></div>
    
<div class="viewcode-block" id="OOP"><a class="viewcode-back" href="../../framework.html#framework.Processing.OOP">[docs]</a><span class="k">def</span> <span class="nf">OOP</span><span class="p">(</span><span class="n">angles</span><span class="p">):</span>
    <span class="n">theta_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>

    <span class="n">OrderTensors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="n">theta_rad</span><span class="p">:</span>
        <span class="n">re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
        <span class="n">OT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">re</span><span class="o">*</span><span class="n">re</span><span class="p">,</span><span class="n">re</span><span class="o">*</span><span class="n">im</span><span class="p">],[</span><span class="n">im</span><span class="o">*</span><span class="n">re</span><span class="p">,</span><span class="n">im</span><span class="o">*</span><span class="n">im</span><span class="p">]])</span>
        <span class="n">OrderTensors</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">OT</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])]</span>

    <span class="n">MOT11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">ot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="n">OrderTensors</span><span class="p">])</span>
    <span class="n">MOT12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">ot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="n">OrderTensors</span><span class="p">])</span>
    <span class="n">MOT22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">ot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="n">OrderTensors</span><span class="p">])</span>
    <span class="n">MOT</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">MOT11</span><span class="p">,</span><span class="n">MOT12</span><span class="p">],[</span><span class="n">MOT12</span><span class="p">,</span><span class="n">MOT22</span><span class="p">]])</span>

    <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">eig</span>
    <span class="n">evals</span><span class="p">,</span><span class="n">evecs</span><span class="o">=</span><span class="n">eig</span><span class="p">(</span><span class="n">MOT</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">evals</span><span class="p">)</span></div>

<div class="viewcode-block" id="subsample_mask"><a class="viewcode-back" href="../../framework.html#framework.Processing.subsample_mask">[docs]</a><span class="k">def</span> <span class="nf">subsample_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">frac</span><span class="p">):</span>
    <span class="n">x</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
    <span class="n">y</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
    <span class="n">meshpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> 
    <span class="n">grelha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">meshpoints</span><span class="p">:</span>
        <span class="n">grelha</span><span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">gridpoints</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">grelha</span>
    
    <span class="k">return</span> <span class="n">gridpoints</span></div>

<div class="viewcode-block" id="radialscore"><a class="viewcode-back" href="../../framework.html#framework.Processing.radialscore">[docs]</a><span class="k">def</span> <span class="nf">radialscore</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">gridpoints</span><span class="p">,</span><span class="n">x_</span><span class="p">,</span><span class="n">y_</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">x_points</span><span class="p">,</span><span class="n">y_points</span><span class="p">,</span><span class="n">points</span><span class="p">,</span><span class="n">mat_scores</span><span class="p">,</span><span class="n">scores</span><span class="p">,</span><span class="n">score</span><span class="p">,</span><span class="n">h_i_s</span><span class="p">,</span><span class="n">angles</span>
    <span class="n">x_points</span><span class="p">,</span><span class="n">y_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gridpoints</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x_points</span><span class="p">,</span><span class="n">y_points</span><span class="p">))</span>
    
    
    <span class="n">mat_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">gridpoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">gridpoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">maxscore</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">line</span>
            <span class="n">p0</span>     <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span> <span class="o">+</span> <span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">min</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="o">+</span> <span class="n">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">p1</span>     <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_</span><span class="p">)</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">min</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Prepare vectors</span>
            <span class="n">med_point</span>      <span class="o">=</span> <span class="p">((</span><span class="n">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,(</span><span class="n">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">center_med_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">med_point</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">line_vec</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
            <span class="n">center_p0</span>      <span class="o">=</span> <span class="n">p0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">center_p1</span>      <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

            <span class="c1"># Statistics</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">center_med_vec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">center_med_vec</span><span class="p">),</span> <span class="n">line_vec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">line_vec</span><span class="p">)))</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error in arccos. Set to 0&#39;</span><span class="p">)</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">-</span> <span class="n">angle</span>
                
            <span class="n">angles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">angle</span><span class="p">]</span>
                
        <span class="c1"># Compute score</span>
        <span class="n">h_i_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">h_i_s</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">4</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">maxscore</span><span class="p">:</span>
            <span class="n">maxscore</span> <span class="o">=</span> <span class="n">score</span>
            <span class="n">maxpoint</span> <span class="o">=</span> <span class="n">p</span>
            
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">+</span> <span class="p">[</span><span class="n">score</span><span class="p">]</span>
        
    <span class="n">mat_scores</span><span class="p">[</span><span class="n">x_points</span><span class="p">,</span><span class="n">y_points</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
    <span class="k">return</span> <span class="n">mat_scores</span></div>


<span class="c1"># def analyze_cell(text_img,mask,hough_params,centroids,OriginalDF,DeconvDF,NucleiDeconvDF,algorithm,plot):</span>
<span class="c1">#     # INPUTS:</span>
<span class="c1">#     # text_img                             = [skeleton, index,texture w/ intensity]</span>
<span class="c1">#     # mask                                 = binary mask</span>
<span class="c1">#     # hough_params                         = [thr, line length, line gap]</span>
<span class="c1">#     # centroids                            = DataFrame with nuclei ID&#39;s, masks, centroids and contours from image</span>
<span class="c1">#     # OriginalDF, DeconvDF, NucleiDeconvDF = Datasets</span>
<span class="c1">#     # plot                                 = True/False</span>
    
<span class="c1">#     global orig_cysk</span>
<span class="c1">#     tmp        = copy.deepcopy(OriginalDF[&#39;Image&#39;][text_img[1]])</span>
<span class="c1">#     tmp[:,:,0] = 0</span>
<span class="c1">#     orig_cysk  = cv2.cvtColor(tmp,cv2.COLOR_RGB2GRAY)</span>
    
<span class="c1">#     global patch_aux,centroid,cr,patch_n,centroid</span>
    
    
<span class="c1">#     # Texture patch for Hough Analysis</span>
<span class="c1">#     global x_,y_,patch,aux_</span>
<span class="c1">#     aux_    = mask * (text_img[0] * 1)</span>
<span class="c1">#     x_,y_   = np.where((mask*1) != 0)</span>
<span class="c1">#     patch   = aux_[min(x_):max(x_),min(y_):max(y_)]</span>
    
<span class="c1">#     # Deconvoluted cytoskeleton patch </span>
<span class="c1">#     global x_f,y_f,patch_f,aux_f</span>
<span class="c1">#     if algorithm == &#39;deconvoluted&#39;:</span>
<span class="c1">#         aux_f   = mask * (DeconvDF[&#39;Image&#39;][text_img[1]] / np.max(DeconvDF[&#39;Image&#39;][text_img[1]]))</span>
<span class="c1"># #     if algorithm == &#39;original&#39;:</span>
<span class="c1"># #         aux_f   = mask * (orig_cysk / np.max(orig_cysk))</span>
<span class="c1">#     x_f,y_f = np.where(aux_f != 0)</span>
<span class="c1">#     patch_f = aux_f[min(x_f):max(x_f),min(y_f):max(y_f)]</span>
<span class="c1">#     patch_f_norm = patch_f / np.max(aux_f)</span>
    
<span class="c1">#     # GET and PLOT centroid</span>
<span class="c1">#     global centroid_list,centroid</span>
<span class="c1">#     centroid_list = []</span>
    
<span class="c1">#     # GET: centroid inside ROI indexes</span>
<span class="c1">#     for idx,row in centroids.iterrows():</span>
<span class="c1">#         if (round(row[&#39;Centroid&#39;][0]),round(row[&#39;Centroid&#39;][1])) in list(zip(x_,y_)): </span>
<span class="c1">#             centroid_list += [idx]</span>
<span class="c1">#     if centroid_list == []:  print(&quot;Error: No centroids within ROI&quot;); return 0,0,0,0,0,0;</span>
<span class="c1">#     if len(centroid_list) &gt; 1: print(&quot;Warning: More than 1 centroid identified within ROI&quot;);</span>
    
<span class="c1">#     # PLOT: first centroid identified and nucleus contour</span>
<span class="c1">#     centroid = centroids.loc[centroid_list[0]][&#39;Centroid&#39;]</span>
    

     
        
<span class="c1">#     # PROCESSING: Line Segment Analysis</span>
<span class="c1">#     global lines, median_points, features2D, features1D</span>
<span class="c1">#     lines, median_points, centroid_list, centroid, cytocenter, radialSC_pos, features2D, features1D = line_segment_features(text_img[0],text_img[1],mask,patch,(x_,y_),centroids,plot)</span>
    

<span class="c1">#     # Deconvoluted nuclei patch</span>
<span class="c1">#     if algorithm == &#39;deconvoluted&#39;:</span>
<span class="c1">#         aux_n    = mask * (NucleiDeconvDF[&#39;Image&#39;][text_img[1]] / np.max(NucleiDeconvDF[&#39;Image&#39;][text_img[1]]))</span>

<span class="c1">#     try:</span>
<span class="c1">#         contourr = centroids.loc[centroid_list[0]][&#39;Contour&#39;] </span>
<span class="c1">#         cr       = contourr.reshape((contourr.shape[0],contourr.shape[2]))</span>
<span class="c1">#     except:</span>
<span class="c1">#         contourr = centroids.loc[centroid_list[0]][&#39;Contour&#39;][0]</span>
<span class="c1">#         cr       = contourr.reshape((contourr.shape[0],contourr.shape[2]))</span>
<span class="c1">#     patch_n  = aux_n[min(cr[:,1]):max(cr[:,1]),min(cr[:,0]):max(cr[:,0])]</span>
<span class="c1">#     patch_n_norm = patch_n / np.max(aux_n)</span>

  
<span class="c1">#     # TEXTURAL ANALYSIS</span>
<span class="c1">#     skel_w_int_full = aux_ * aux_f   </span>
<span class="c1">#     skel_w_int = skel_w_int_full[min(x_):max(x_),min(y_):max(y_)]</span>
<span class="c1">#     AAI = getAAI(skel_w_int)</span>
<span class="c1">#     #AAI = 0</span>
    
<span class="c1">#     # PROCESSING: **CYTOSKELETONS**</span>
<span class="c1">#     b,d              = fractal_dimension_grayscale(patch)</span>
<span class="c1">#     fractal_values_b = [round(b,3)]</span>
<span class="c1">#     fractal_values_d = [round(d,3)]</span>
<span class="c1">#     fdske            = [round(fractal_dimension(patch),3)]</span>
<span class="c1">#     fd_deconv        = [round(fractal_dimension(patch_f_norm),3)]</span>
        
<span class="c1">#     feats_all                    = ImageFeatures((patch_f_norm *255).astype(np.uint8))</span>
<span class="c1">#     feats_labels_, feats_values_ = feats_all.print_features(print_values = False)</span>
<span class="c1">#     feats_labels_, feats_values_ = remove_not1D(feats_labels_,feats_values_)</span>
<span class="c1">#     feats_labels_                = [&#39;DCF:&#39; + ftf for ftf in feats_labels_]</span>
 
<span class="c1">#     # PROCESSING: **NUCLEI**</span>
<span class="c1">#     b_n,d_n = fractal_dimension_grayscale(patch_n_norm)</span>
<span class="c1">#     fractal_values_n_b = [round(b_n)]</span>
<span class="c1">#     fractal_values_n_d = [round(d_n)] </span>
<span class="c1">#     fd_nuc  = [fractal_dimension(patch_n_norm)]</span>
    
<span class="c1">#     feats_all_n                      = ImageFeatures((patch_n_norm *255).astype(np.uint8))</span>
<span class="c1">#     feats_labels_n_, feats_values_n_ = feats_all_n.print_features(print_values = False)</span>
<span class="c1">#     feats_labels_n_, feats_values_n_ = remove_not1D(feats_labels_n_,feats_values_n_)</span>
<span class="c1">#     feats_labels_n_                  = [&#39;DNF:&#39; + ftn for ftn in feats_labels_n_]</span>
    
<span class="c1">#     # PROCESSING: Graph Analysis</span>
<span class="c1">#     global int_ske, graph, graph_res, shollhist, cncd, pxlcount</span>
<span class="c1">#     int_ske         = ((text_img[0] * 1) * aux_f) / np.max(aux_f) #1040x1388</span>
<span class="c1">#     graph,graph_res,shollhist = graphAnalysis(int_ske,[x_,y_],[aux_n / np.max(patch_n),centroid,cr],mask,plot)</span>
    
<span class="c1">#     # PROCESSING: Others</span>
<span class="c1">#     cncd = Others(aux_f,aux_n,lines)</span>
    
<span class="c1">#     # Add to DataFrame</span>
<span class="c1">#     global ImageLinesDF,new</span>
<span class="c1">#     if &#39;ResultsDF&#39; not in globals():</span>
<span class="c1">#             ImageLinesDF = pd.DataFrame(columns = [&#39;Name&#39;] + [&#39;Img Index&#39;] + [&#39;Label&#39;] + [&#39;Mask&#39;] + [&#39;Patches&#39;] + [&#39;Nucleus Centroid&#39;] + [&#39;Cytoskeleton Centroid&#39;] + [&#39;Nucleus Contour&#39;] + [&#39;Centrossome&#39;] + [&#39;Lines&#39;] + [&#39;Graph&#39;] + [&#39;Sholl Hist&#39;] + [x for x,y in features2D] + [xe for xe,ye in features1D] + [&#39;DCF:AAI&#39;] + [&#39;DCF:Fractal Dim B Skeleton&#39;] + [&#39;DCF:Fractal Dim D Skeleton&#39;] + [&#39;DCF:Fractal Dim Skeleton&#39;] + [&#39;DCF:Fractal Dim Grayscale&#39;] + [&#39;DNF:Nuclei Grayscale Fractal Dim &#39;] + list(feats_labels_n_) + [graph_ft for graph_ft in list(zip(*graph_res))[0]] + [x for x,y in cncd])</span>
<span class="c1">#     new          = pd.Series([DeconvDF[&#39;Name&#39;][text_img[1]]] + [text_img[1]] + [DeconvDF[&#39;Label&#39;][text_img[1]]] + [mask] + [[patch,patch_f,patch_n,aux_* orig_cysk,x_,y_]] + [centroid] + [cytocenter] + [cr] + [radialSC_pos] + [lines] + [[graph]] + [shollhist] + [y for x,y in features2D] + [ye for xe,ye in features1D] + [AAI] + fractal_values_b + fractal_values_d + fdske + fd_deconv + fd_nuc + feats_values_n_ + [graph_ft for graph_ft in list(zip(*graph_res))[1]] + [y for x,y in cncd],index=ImageLinesDF.columns)</span>
<span class="c1">#     ImageLinesDF = ImageLinesDF.append(new,ignore_index=True)</span>
        
<span class="c1">#     return ImageLinesDF</span>



<span class="c1"># def line_segment_features(original_img,img_index,mask,patch,xy,centroids,plot):</span>
<span class="c1">#     # original_img = original skeleton image</span>
<span class="c1">#     # img_index    = image index</span>
<span class="c1">#     # mask         = ROI mask of desired cell </span>
<span class="c1">#     # patch        = np.array with skeleton p atch</span>
<span class="c1">#     # xy           = [x_,y_] = [(x1,x2),(y1,y2)]</span>
<span class="c1">#     # centroids    = Centroids[image index] dataframe</span>
    
<span class="c1">#     # Get offset</span>
<span class="c1">#     x_ = xy[0]</span>
<span class="c1">#     y_ = xy[1]</span>
    
<span class="c1">#     # Get patch</span>
<span class="c1">#     if mask.any() != None:</span>
<span class="c1">#         aux__   = original_img * mask</span>
<span class="c1">#         x_,y_   = np.where(mask != 0)</span>
<span class="c1">#         patch   = aux__[min(x_):max(x_),min(y_):max(y_)]</span>
        
 
<span class="c1">#     # GET and PLOT centroid</span>
<span class="c1">#     centroid_list = []</span>
    
<span class="c1">#     # GET: centroid inside ROI indexes</span>
<span class="c1">#     for idx,row in centroids.iterrows():</span>
<span class="c1">#         if (round(row[&#39;Centroid&#39;][0]),round(row[&#39;Centroid&#39;][1])) in list(zip(x_,y_)): </span>
<span class="c1">#             centroid_list += [idx]</span>
<span class="c1">#     if centroid_list == []:  print(&quot;Error: No centroids within ROI&quot;); return 0,0,0,0,0,0;</span>
<span class="c1">#     if len(centroid_list) &gt; 1: print(&quot;Warning: More than 1 centroid identified within ROI&quot;);</span>
    
<span class="c1">#     # PLOT: first centroid identified and nucleus contour</span>
<span class="c1">#     centroid = centroids.loc[centroid_list[0]][&#39;Centroid&#39;]</span>
        
<span class="c1">#     # cytoskeleton centroid</span>
<span class="c1">#     aa = aux__ * 1</span>
<span class="c1">#     cytocenter = regionprops((aa!=0)*1,aa)[0].centroid</span>
     
    
<span class="c1">#     # HOUGH ANALYSIS</span>
<span class="c1">#     lsd   = cv2.createLineSegmentDetector(cv2.LSD_REFINE_ADV,2.5,0.001,0,90,-200,0.5,2048)</span>
<span class="c1">#     lines = cv2toski(lsd.detect((patch * 255).astype(np.uint8))[0])</span>
<span class="c1">#     lines = [((round(min(y_) + l[0][0],3),round(min(x_) + l[0][1],3)),(round(min(y_) + l[1][0],3),round(min(x_) + l[1][1],3))) for l in lines] # Recenter (Fix offset)</span>
    
<span class="c1">#     # Number of Lines</span>
<span class="c1">#     N = len(lines)</span>
    
<span class="c1">#     # Distance matrix features</span>
<span class="c1">#     median_points = [((line[0][0] + line[1][0])/2,(line[0][1] + line[1][1])/2) for line in lines]</span>
<span class="c1">#     d             = distance_matrix(median_points,median_points); np.fill_diagonal(d,np.max(d));</span>
<span class="c1">#     d_0           = distance_matrix(median_points,median_points); np.fill_diagonal(d_0,0);</span>
    
<span class="c1">#     # Intracluster metrics</span>
<span class="c1">#     max_d          = np.max(d)</span>
<span class="c1">#     avg_diam_dist  = np.sum(d_0) / (len(lines)*(len(lines) - 1))</span>
<span class="c1">#     center         = (np.mean(np.array(median_points)[:,0]), np.mean(np.array(median_points)[:,1]))</span>
<span class="c1">#     cent_diam_dist = 2*np.sum([np.linalg.norm(np.array(m)-np.array(center)) for m in median_points]) / len(lines)</span>
    
<span class="c1">#     # HOUGH ANALYSIS</span>
<span class="c1">#     angles,dist_med,triangleA,line_size,thetas,close_angle,std_locals,std_dists,prox,PADs,thetas_w = [],[],[],[],[],[],[],[],[],[],[]</span>
    

<span class="c1">#     prev_v = np.array([0,0])</span>
<span class="c1">#     prev_vs = [np.array([0,0])]</span>
<span class="c1">#     ind = 0</span>
<span class="c1">#     for line in lines:</span>
<span class="c1">#         p0, p1 = line</span>

<span class="c1">#         # Prepare vectors</span>
<span class="c1">#         med_point      = ((p0[0] + p1[0])/2,(p0[1] + p1[1])/2)</span>
<span class="c1">#         center_med_vec = np.array(med_point) - np.array([centroid[1],centroid[0]])</span>
<span class="c1">#         line_vec       = np.array(p1) - np.array(p0)</span>
<span class="c1">#         center_p0      = p0 - np.array([centroid[1],centroid[0]])</span>
<span class="c1">#         center_p1      = p1 - np.array([centroid[1],centroid[0]])</span>
        
<span class="c1">#         ### Features</span>
<span class="c1">#         # ALPHA</span>
<span class="c1">#         angle = np.arccos(np.dot(center_med_vec / np.linalg.norm(center_med_vec), line_vec / np.linalg.norm(line_vec)))*180/np.pi</span>
<span class="c1">#         if angle &gt; 90: angle = 180 - angle;</span>
            
<span class="c1">#         # THETA</span>
<span class="c1">#         if p0[0] != p1[0]:</span>
<span class="c1">#             #theta = np.arctan(abs(p1[1]-p0[1])/abs(p1[0]-p0[0]))*180/np.pi</span>
<span class="c1">#             theta = np.arctan(line_vec[1]/line_vec[0])*180/np.pi</span>
<span class="c1">#         else:</span>
<span class="c1">#             theta = 90</span>
<span class="c1">#         if not 0 &lt; theta &lt; 180:  theta = 180 + theta;</span>
        
<span class="c1">#         # MAIN VECTOR</span>
<span class="c1">#         if np.linalg.norm(prev_v + line_vec) &gt; np.linalg.norm(prev_v):</span>
<span class="c1">#             prev_v = prev_v + line_vec</span>
<span class="c1">#         elif np.linalg.norm(prev_v - line_vec) &gt; np.linalg.norm(prev_v):</span>
<span class="c1">#             prev_v = prev_v - line_vec</span>
<span class="c1">#         prev_vs += [prev_v]</span>
<span class="c1">#         theta_w = np.linalg.norm(line_vec) * theta * np.pi/180 </span>
<span class="c1">#         thetas_w += [theta_w]</span>
        
<span class="c1">#         ### LOCAL FEATURES</span>
<span class="c1">#         # CLOSEST LINES vs. THIS LINE</span>
<span class="c1">#         copy_d            = copy.deepcopy(d[ind])</span>
<span class="c1">#         dists_to_medpoint = copy_d</span>
        
<span class="c1">#         # get indices of the 5 closest lines</span>
<span class="c1">#         closest_angles = []</span>
<span class="c1">#         prox_lines     = []</span>
<span class="c1">#         thetas_        = []</span>
<span class="c1">#         mean_angles    = []</span>
        
<span class="c1">#         for _ in range(5):</span>
<span class="c1">#             # calculate angle of the _&#39;th closest line</span>
<span class="c1">#             min_val          = np.min(dists_to_medpoint)</span>
<span class="c1">#             close_line_ind   = np.where(dists_to_medpoint == min_val)[0][0]</span>
<span class="c1">#             p0_c, p1_c       = lines[close_line_ind] </span>
<span class="c1">#             med_point_c      = ((p0_c[0] + p1_c[0])/2,(p0_c[1] + p1_c[1])/2)</span>
<span class="c1">#             center_med_vec_c = np.array(med_point_c) - np.array([centroid[1],centroid[0]])</span>
<span class="c1">#             line_vec_c       = np.array(p1_c) - np.array(p0_c)</span>
            
<span class="c1">#             # ALPHA</span>
<span class="c1">#             try:</span>
<span class="c1">#                 angle_c          = np.arccos(np.dot(center_med_vec_c / np.linalg.norm(center_med_vec_c), line_vec_c / np.linalg.norm(line_vec_c)))*180/np.pi</span>
<span class="c1">#             except:</span>
<span class="c1">#                 print(&#39;error found in angle_c - arccos&#39;)</span>
<span class="c1">#                 angle_c = 0  </span>
<span class="c1">#             if angle_c &gt; 90: angle_c = 180 - angle_c;</span>
            
<span class="c1">#             # THETA</span>
<span class="c1">#             if p0_c[0] != p1_c[0]: </span>
<span class="c1">#                 theta_c = np.arctan(line_vec_c[1]/line_vec_c[0])*180/np.pi</span>
<span class="c1">#             else: </span>
<span class="c1">#                 theta_c = 90</span>
<span class="c1">#             if not 0 &lt; theta_c &lt; 180:  theta_c = 180 + theta_c;</span>
        
<span class="c1">#             # Add to lists</span>
<span class="c1">#             closest_angles = closest_angles + [abs(theta - theta_c)]</span>
<span class="c1">#             prox_lines     = prox_lines + [min_val]</span>
<span class="c1">#             thetas_        = thetas_ + [theta_c]</span>
            
<span class="c1">#             # Next line</span>
<span class="c1">#             dists_to_medpoint[close_line_ind] = max_d</span>
           
<span class="c1">#         mean_angles += [np.mean(thetas_)]  </span>
<span class="c1">#         # ---</span>
        
<span class="c1">#         # Add features to list</span>
<span class="c1">#         angles      += [round(angle,3)]</span>
<span class="c1">#         dist_med    += [round(np.linalg.norm(center_med_vec),3)]</span>
<span class="c1">#         triangleA   += [round(abs(0.5*np.cross(center_p0,center_p1)),3)]</span>
<span class="c1">#         line_size   += [round(np.linalg.norm(line_vec),3)]</span>
<span class="c1">#         thetas      += [round(theta,3)]</span>
<span class="c1">#         close_angle += [round(np.mean(closest_angles),3)]</span>
<span class="c1">#         std_locals  += [round(np.std(closest_angles),3)]</span>
<span class="c1">#         prox        += [round(np.mean(prox_lines),3)]</span>
<span class="c1">#         std_dists   += [round(np.std(prox_lines),3)]</span>
<span class="c1">#         PADs        += [round(np.sqrt(sum((np.array(thetas_) - np.mean(thetas_))**2) / 5),3)]</span>
        
<span class="c1">#         # next line</span>
<span class="c1">#         ind = ind + 1</span>
    
<span class="c1">#     # OOP, HI, Main Vector Magnitude, TAD</span>
<span class="c1">#     oop = OOP(thetas)</span>
<span class="c1">#     hi  = HI(thetas)</span>
<span class="c1">#     mcm = np.linalg.norm(prev_v)</span>
<span class="c1">#     tad = np.sqrt(sum((np.array(mean_angles) - np.mean(thetas))**2) / N)</span>
    
<span class="c1">#     # RADIAL SCORE</span>
<span class="c1">#     gridpoints   = subsample_mask(mask,5)</span>
<span class="c1">#     mat_scores   = radialscore(lines,gridpoints,x_,y_)</span>
<span class="c1">#     radialSC     = round(np.max(mat_scores),3)</span>
<span class="c1">#     radialSC_pos = [np.argwhere(mat_scores == np.max(mat_scores))[0]]</span>
    
<span class="c1">#     # SAVE FEATURES</span>
<span class="c1">#     features2D = [(&#39;LSF2D:Angles&#39;,angles),</span>
<span class="c1">#                   (&#39;LSF2D:Distances to Centroid&#39;,dist_med),</span>
<span class="c1">#                   (&#39;LSF2D:Triangle Areas&#39;,triangleA),</span>
<span class="c1">#                   (&#39;LSF2D:Line Lengths&#39;,line_size),</span>
<span class="c1">#                   (&#39;LSF2D:Theta&#39;,thetas),</span>
<span class="c1">#                   (&#39;LSF2D:Angle Difference&#39;,close_angle),</span>
<span class="c1">#                   (&#39;LSF2D:Std. Angle Difference&#39;,std_locals),</span>
<span class="c1">#                   (&#39;LSF2D:Local Line Distance&#39;,prox),</span>
<span class="c1">#                   (&#39;LSF2D:Std. Local Line Distance&#39;,std_dists),</span>
<span class="c1">#                   (&#39;LSF2D:PAD&#39;,PADs)]</span>
    
<span class="c1">#     features1D = [(&#39;LSF1D:Number of Lines&#39;,N),</span>
<span class="c1">#                   (&#39;LSF1D:Radial Score&#39;,radialSC),</span>
<span class="c1">#                   (&#39;LSF1D:Complete Diameter Distance&#39;,max_d),</span>
<span class="c1">#                   (&#39;LSF1D:Average Diameter Distance&#39;,avg_diam_dist),</span>
<span class="c1">#                   (&#39;LSF1D:TAD&#39;,tad),</span>
<span class="c1">#                   (&#39;LSF1D:OOP&#39;,oop),</span>
<span class="c1">#                   (&#39;LSF1D:HI&#39;,hi),</span>
<span class="c1">#                   (&#39;LSF1D:MCM&#39;,mcm)]</span>
                                                                                         
<span class="c1">#     return lines, median_points, centroid_list, centroid, cytocenter, radialSC_pos, features2D, features1D</span>

<div class="viewcode-block" id="df_analyze_cell"><a class="viewcode-back" href="../../framework.html#framework.Processing.df_analyze_cell">[docs]</a><span class="k">def</span> <span class="nf">df_analyze_cell</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">ROIsDF</span><span class="p">):</span>
    <span class="c1"># Get labels and remove synthetic images</span>
    <span class="n">labels</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ROIsDF</span><span class="p">[</span><span class="s1">&#39;Label&#39;</span><span class="p">]))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;Synthetic&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">ROIsDF</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="c1"># Analyse cell from ROI</span>
        <span class="c1">#ResultsDF = analyze_cell([skeleton, row[&#39;Index&#39;]],row[&#39;ROImask&#39;],[2,2.5,1],Centroids[row[&#39;Index&#39;]],OriginalDF,DeconvDF,NucleiDeconvDF,&#39;deconvoluted&#39;,False)</span>
        <span class="n">ResultsDF</span> <span class="o">=</span> <span class="n">analyze_cell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">algorithm_cyto</span><span class="p">,</span><span class="n">algorithm_nuclei</span><span class="p">,</span><span class="n">LSFparams</span><span class="p">,</span><span class="n">features</span><span class="p">,</span><span class="n">plot</span><span class="p">)</span>
        
        <span class="c1"># Print progress</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; Progress: &quot;</span> <span class="o">+</span> <span class="nb">round</span><span class="p">((</span><span class="n">count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ROIs</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">ResultsDF</span></div>

<div class="viewcode-block" id="process3Dnuclei"><a class="viewcode-back" href="../../framework.html#framework.Processing.process3Dnuclei">[docs]</a><span class="k">def</span> <span class="nf">process3Dnuclei</span><span class="p">(</span><span class="n">dir_masks</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">ball</span><span class="p">,</span> <span class="n">binary_dilation</span>
    <span class="kn">from</span> <span class="nn">tifffile</span> <span class="kn">import</span> <span class="n">imread</span><span class="p">,</span> <span class="n">imwrite</span>
    <span class="kn">from</span> <span class="nn">stardist.models</span> <span class="kn">import</span> <span class="n">StarDist3D</span>
    <span class="kn">from</span> <span class="nn">csbdeep.utils</span> <span class="kn">import</span> <span class="n">Path</span><span class="p">,</span> <span class="n">normalize</span>
    <span class="kn">from</span> <span class="nn">stardist.geometry</span> <span class="kn">import</span> <span class="n">dist_to_coord3D</span>
    <span class="kn">import</span> <span class="nn">napari</span>

    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_masks</span><span class="p">):</span>
        <span class="c1"># Get image</span>
        <span class="n">path</span>     <span class="o">=</span> <span class="n">dir_masks</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">img</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">nuc_mask</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">16</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">18</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">20</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">34</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">36</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">38</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Initialize DataFrame to put the Centroids in:</span>
        <span class="c1">#isolated_nucleus = pd.DataFrame(columns=[&#39;ID&#39;,&#39;Mask With ID&#39;,&#39;Centroid&#39;,&#39;Contour&#39;])</span>

        <span class="k">global</span> <span class="n">aux</span><span class="p">,</span><span class="n">bin_nuclei</span><span class="p">,</span><span class="n">imgg</span>
        <span class="c1"># Obtain isolated nucleus</span>
        <span class="n">org</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;3D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;Image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">maxorg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">org</span><span class="p">)</span>
        <span class="n">orgnorm</span> <span class="o">=</span> <span class="n">org</span> <span class="o">/</span> <span class="n">maxorg</span>
        
        <span class="n">nuid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">nucleus</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">nuc_mask</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nucleus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#Not background</span>
                
                <span class="n">aux</span>  <span class="o">=</span> <span class="n">nuc_mask</span> <span class="o">==</span> <span class="n">nucleus</span>
                <span class="n">mask_w_id</span> <span class="o">=</span> <span class="n">aux</span><span class="o">*</span><span class="n">nuc_mask</span>
                <span class="n">bin_nuclei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_w_id</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">bin_nuclei</span> <span class="o">=</span> <span class="n">binary_dilation</span><span class="p">(</span><span class="n">bin_nuclei</span><span class="p">,</span><span class="n">footprint</span><span class="o">=</span><span class="n">ball</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                
                <span class="n">imgg</span> <span class="o">=</span> <span class="n">orgnorm</span> <span class="o">*</span> <span class="n">bin_nuclei</span>
                
                <span class="n">xp</span><span class="p">,</span><span class="n">yp</span><span class="p">,</span><span class="n">zp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bin_nuclei</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">pixels</span>   <span class="o">=</span> <span class="p">[</span><span class="n">xp</span><span class="p">,</span><span class="n">yp</span><span class="p">,</span><span class="n">zp</span><span class="p">]</span>

                <span class="c1">#print(bin_nuclei.shape,np.unique(bin_nuclei))</span>
                <span class="k">global</span> <span class="n">feats_all_n</span><span class="p">,</span><span class="n">feats_values_n_</span>
                <span class="n">feats_all_n</span>                      <span class="o">=</span> <span class="n">ImageFeatures</span><span class="p">((</span><span class="n">imgg</span> <span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">Datasets</span><span class="se">\\</span><span class="s2">Set 3D</span><span class="se">\\</span><span class="s2">3D</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">img</span><span class="p">)</span>
                <span class="n">feats_labels_n_</span><span class="p">,</span> <span class="n">feats_values_n_</span> <span class="o">=</span> <span class="n">feats_all_n</span><span class="o">.</span><span class="n">print_features</span><span class="p">(</span><span class="n">print_values</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">feats_labels_n_</span><span class="p">,</span> <span class="n">feats_values_n_</span> <span class="o">=</span> <span class="n">remove_not1D</span><span class="p">(</span><span class="n">feats_labels_n_</span><span class="p">,</span><span class="n">feats_values_n_</span><span class="p">)</span>
                <span class="n">feats_labels_n_</span>                  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DNF:&#39;</span> <span class="o">+</span> <span class="n">ftn</span> <span class="k">for</span> <span class="n">ftn</span> <span class="ow">in</span> <span class="n">feats_labels_n_</span><span class="p">]</span>
                
                
                
                <span class="k">if</span> <span class="s1">&#39;nucDF&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
                    <span class="k">global</span> <span class="n">nucDF</span>
                    <span class="n">nucDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Img Index&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Label&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Nucleus Mask&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">feats_labels_n_</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">feats_labels_n_</span><span class="p">,</span> <span class="n">feats_values_n_</span><span class="p">)</span> <span class="o">!=</span> <span class="p">([],[]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">Datasets</span><span class="se">\\</span><span class="s2">Set 3D</span><span class="se">\\</span><span class="s2">3D</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">img</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">label_image</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">nucleus</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">pixels</span><span class="p">]</span> <span class="o">+</span> <span class="n">feats_values_n_</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">nucDF</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

                        <span class="n">nucDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">nucDF</span><span class="p">,</span><span class="n">new</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span> 
                        <span class="k">pass</span>
                
                
                
            <span class="n">nuid</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">nuid</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">nuc_mask</span><span class="p">)))</span>
<span class="c1">#         # Add Centroids obtained from the image to dict:</span>
<span class="c1">#         Centroids[int(img.split(&#39;_&#39;)[1])] = isolated_nucleus</span>
        
    
<span class="c1">#         # Print progress</span>
<span class="c1">#         print(&quot;Image &quot; + str(int(img.split(&#39;_&#39;)[1])) + &quot; done.&quot;)</span>
<span class="c1">#     print(&#39;Done. Printing dict.&#39;)</span>

    <span class="k">return</span> <span class="n">nucDF</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Diogo Fris Vieira.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>